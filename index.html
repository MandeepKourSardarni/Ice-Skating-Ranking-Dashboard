<!DOCTYPE html>
<html>
<head>
<title>Ice Skating Short Track Ranking Dashboard</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
/* -----------------------------------------------------------
   GLOBAL + BACKGROUND
------------------------------------------------------------ */
body {
    margin:0;
    padding:0;
    font-family:'Segoe UI', Arial, sans-serif;
    color:white;
    background:#001428;
}

.bg {
    background-image:url("https://github.com/MandeepKourSardarni/Ice-Skating-short-track-Ranking-Dashboard/blob/main/image.jpg");
    background-size:cover;
    background-position:center;
    background-attachment:fixed;
    position:fixed;
    inset:0;
    opacity:0.35;
    z-index:-3;
}

.bgOverlay {
    position:fixed;
    inset:0;
    background:rgba(0,0,30,0.6);
    z-index:-2;
}

/* -----------------------------------------------------------
   HEADER
------------------------------------------------------------ */
.headerBar {
    width:95%;
    margin:25px auto 20px auto;
    padding:15px;
    text-align:center;
    background:rgba(255,255,255,0.06);
    border-radius:14px;
    backdrop-filter:blur(14px);
    box-shadow:0 0 18px rgba(0,120,255,0.45);
}

h1 {
    margin:0;
    font-size:26px;
    font-weight:700;
    text-shadow:0 0 16px rgba(0,160,255,0.9);
}

/* -----------------------------------------------------------
   CONTROL PANEL (MOBILE FIRST)
------------------------------------------------------------ */
.control-row {
    width:95%;
    margin:auto;
    display:flex;
    flex-direction:column;
    gap:14px;
}

.control-col {
    background:rgba(255,255,255,0.07);
    padding:12px;
    border-radius:12px;
    backdrop-filter:blur(14px);
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    justify-content:center;
    box-shadow:0 0 18px rgba(0,120,255,0.35);
}

input, select, button {
    height:40px;
    padding:5px 12px;
    border-radius:6px;
    border:none;
    font-size:15px;
}

input, select {
    background:white;
    color:#000;
}

button {
    background:#007bff;
    color:white;
    cursor:pointer;
}

button:hover {
    background:#4ea3ff;
}

.danger { background:#ff3d3d !important; }
.danger:hover { background:#ff7878 !important; }

/* -----------------------------------------------------------
   VIEW GROUP SELECTOR
------------------------------------------------------------ */
.viewBar {
    width:95%;
    margin:22px auto;
    padding:14px;
    background:rgba(255,255,255,0.07);
    border-radius:12px;
    text-align:center;
    backdrop-filter:blur(14px);
    box-shadow:0 0 18px rgba(0,120,255,0.35);
}

/* -----------------------------------------------------------
   TABLE ‚Äî SHOWN ONLY ON DESKTOP/TABLET
------------------------------------------------------------ */
table {
    width:95%;
    margin:25px auto;
    border-collapse:collapse;
    background:rgba(255,255,255,0.08);
    border-radius:14px;
    overflow:hidden;
    display:none; /* HIDDEN ON MOBILE */
}

th, td {
    border-bottom:1px solid rgba(255,255,255,0.18);
    padding:10px;
    text-align:center;
}

th {
    background:rgba(0,80,140,0.8);
    font-size:16px;
}

td.name {
    text-align:left;
    padding-left:12px;
}

/* -----------------------------------------------------------
   MOBILE CARD VIEW
------------------------------------------------------------ */
#mobileCards {
    width:95%;
    margin:20px auto;
    display:flex;
    flex-direction:column;
    gap:14px;
}

.card {
    background:rgba(255,255,255,0.08);
    padding:14px;
    border-radius:14px;
    box-shadow:0 0 14px rgba(0,120,255,0.35);
    backdrop-filter:blur(14px);
}

.card h3 {
    margin:0 0 8px 0;
    font-size:18px;
    text-shadow:0 0 6px rgba(0,150,255,0.8);
    cursor:pointer;
}

.card-row {
    display:flex;
    justify-content:space-between;
    margin:6px 0;
}

/* -----------------------------------------------------------
   NAME EDIT POPUP
------------------------------------------------------------ */
#nameEditPopup {
    position:fixed;
    top:50%; left:50%;
    transform:translate(-50%,-50%);
    width:90%; max-width:380px;
    background:#002647;
    padding:18px;
    border-radius:12px;
    box-shadow:0 0 18px rgba(0,150,255,1);
    display:none;
    z-index:300;
}

#nameEditPopup input {
    width:100%;
    margin:12px 0;
}

/* -----------------------------------------------------------
   ERROR POPUP
------------------------------------------------------------ */
#excelErrorPopup {
    position:fixed;
    left:50%;
    top:-300px;
    transform:translateX(-50%);
    width:90%;
    max-width:420px;
    background:#001e36;
    padding:20px;
    border-radius:12px;
    color:white;
    text-align:center;
    z-index:300;
    box-shadow:0 0 18px rgba(0,150,255,1);
    animation-duration:0.7s;
    animation-fill-mode:forwards;
}

@keyframes slideDown {
    from { top:-300px; opacity:0; }
    to   { top:110px; opacity:1; }
}

/* -----------------------------------------------------------
   RESPONSIVE BREAKPOINTS
------------------------------------------------------------ */

/* TABLE MODE FOR SCREENS ABOVE 768px */
@media(min-width:768px){
    table { display:table; }
    #mobileCards { display:none; }
    .control-row { flex-direction:row; }
}
</style>
</head>

<body>

<div class="bg"></div>
<div class="bgOverlay"></div>

<div class="headerBar">
    <h1>Ice Skating Short Track Ranking Dashboard</h1>
</div>

<!-- CONTROL PANEL -->
<div class="control-row">

    <!-- Column 1 -->
    <div class="control-col">
        <input type="file" id="excelFile" accept=".xls,.xlsx">
        <button onclick="uploadExcel()">Upload Excel</button>
    </div>

    <!-- Column 2 -->
    <div class="control-col">
        <input id="skaterName" placeholder="Manually enter the name">
        <button onclick="addManual()">Add</button>

        <select id="addGroupSelect">
            <option>Alpha</option><option>Bravo</option><option>Charlie</option>
            <option>Delta</option><option>Echo</option><option>Foxtrot</option>
            <option>Golf</option><option>Hotel</option><option>India</option>
        </select>
    </div>

    <!-- Column 3 -->
    <div class="control-col">
        <button class="danger" onclick="resetGroup()">Reset Group</button>
        <button class="danger" onclick="resetAll()">Reset All</button>
        <button onclick="openHelp()">Help</button>
    </div>

</div>

<!-- GROUP SELECT -->
<div class="viewBar">
    <label style="font-size:17px;font-weight:bold;">Select Group to View Scoreboard</label><br>
    <select id="viewGroupSelect" onchange="switchGroup()" style="width:220px;margin-top:6px;">
        <option>Alpha</option><option>Bravo</option><option>Charlie</option>
        <option>Delta</option><option>Echo</option><option>Foxtrot</option>
        <option>Golf</option><option>Hotel</option><option>India</option>
    </select>
</div>

<!-- DESKTOP TABLE -->
<table id="scoreTable">
    <thead>
        <tr>
            <th>Name</th>
            <th>400</th><th>500</th><th>800</th><th>1000</th><th>1500</th>
            <th>Total</th><th>Rank</th><th>Undo</th><th>Delete</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<!-- MOBILE CARDS -->
<div id="mobileCards"></div>

<!-- NAME EDIT POPUP -->
<div id="nameEditPopup">
    <h3>Edit Name</h3>
    <input id="nameEditInput">
    <button onclick="saveNameEdit()">Save</button>
    <button class="danger" onclick="closeNamePopup()">Cancel</button>
</div>

<!-- EXCEL ERROR POPUP -->
<div id="excelErrorPopup">
    <p style="font-size:16px;">
        <b><i>Sorry ‚Äî Excel file didn‚Äôt upload properly.<br><br>
        Please try again or enter names manually.</i></b>
    </p>
    <button onclick="closeExcelErrorPopup()" style="margin-top:10px;">Close</button>
</div>

<!-- HELP POPUP -->
<div id="helpPopup" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; display:none; align-items:center; justify-content:center; z-index:250; background:rgba(0,0,0,0.6);">
    <div style="padding:20px; background:#002a4c; border-radius:12px; max-width:420px; width:90%; color:white;">
        <h2>Instructions</h2>
        <p>‚Ä¢ Upload Excel (‚ÄúDivisions‚Äù sheet) or add names manually.</p>
        <p>‚Ä¢ Choose the correct group (Alpha‚ÄìIndia) before adding names.</p>
        <p>‚Ä¢ Tap/click any name to edit it if needed.</p>
        <p>‚Ä¢ Select race positions for 400, 500, 800, 1000, 1500.</p>
        <p>‚Ä¢ Scores, ranks, and medals update automatically.</p>
        <p>‚Ä¢ Undo reverses the last change for that skater.</p>
        <p>‚Ä¢ Delete removes a skater and their scores.</p>
        <p>‚Ä¢ Reset Group clears only the current group.</p>
        <p>‚Ä¢ Reset All clears all groups (use carefully).</p>
        <p>‚Ä¢ Everything is auto-saved in your browser (LocalStorage).</p>
        <button onclick="closeHelp()" style="margin-top:14px;">Close</button>
    </div>
</div>

<script>
// DATA + CONFIG
let groups={};
["Alpha","Bravo","Charlie","Delta","Echo","Foxtrot","Golf","Hotel","India"]
.forEach(g=>groups[g]={skaters:[],history:{}});

if(localStorage.getItem("groupsData")){
    groups=JSON.parse(localStorage.getItem("groupsData"));
}

let currentGroup="Alpha";
const distances=["400","500","800","1000","1500"];

const points={1:1000,2:816,3:666,4:543,5:443,6:362,7:295,8:241,9:196,10:160,
              11:130,12:106,13:86,14:70,15:57};

const validGroups=["ALPHA","BRAVO","CHARLIE","DELTA","ECHO","FOXTROT","GOLF","HOTEL","INDIA"];

function saveData(){ localStorage.setItem("groupsData",JSON.stringify(groups)); }

// GROUP SWITCH
function switchGroup(){
    currentGroup=document.getElementById("viewGroupSelect").value;
    loadGroup();
}

// RESET
function resetGroup(){
    if(!confirm("Reset this group?")) return;
    groups[currentGroup]={skaters:[],history:{}};
    saveData();
    loadGroup();
}

function resetAll(){
    if(!confirm("Reset ALL groups?")) return;
    ["Alpha","Bravo","Charlie","Delta","Echo","Foxtrot","Golf","Hotel","India"]
    .forEach(g=>groups[g]={skaters:[],history:{}});
    saveData();
    loadGroup();
}

// NAME CLEANER
function cleanName(n){
    if(!n) return "";
    return n.replace(/[0-9]/g,"").replace(/\s+/g," ").trim();
}

// MANUAL ADD
function addManual(){
    let name=cleanName(document.getElementById("skaterName").value.trim());
    if(!name) return;
    let g=document.getElementById("addGroupSelect").value;
    addSkater(name,g);
    document.getElementById("skaterName").value="";
}

function addSkater(name,group){
    let G=groups[group];
    if(!G.skaters.includes(name)){
        G.skaters.push(name);
        G.history[name]={"400":[],"500":[],"800":[],"1000":[],"1500":[]};
    }
    saveData();
    if(group===currentGroup) loadGroup();
}

// EXCEL UPLOAD
function uploadExcel(){
    let file=document.getElementById("excelFile").files[0];
    if(!file){ alert("Select Excel file"); return; }

    let reader=new FileReader();
    reader.onload=e=>{
        let data=new Uint8Array(e.target.result);
        let book=XLSX.read(data,{type:'array'});
        let sheet=book.Sheets["Divisions"];
        if(!sheet) return showExcelErrorPopup();

        let rows=XLSX.utils.sheet_to_json(sheet,{header:1});
        let detected=null, added=0;

        for(let row of rows){
            if(!row) continue;

            let groupCell=row[7];
            if(typeof groupCell==="string"){
                let G=groupCell.trim().toUpperCase();
                if(validGroups.includes(G)){
                    detected=G.charAt(0)+G.slice(1).toLowerCase();
                    continue;
                }
            }

            let c1=(row[1]||"").toString().trim();
            let c2=(row[2]||"").toString().trim();
            let c3=(row[3]||"").toString().trim();
            let c4=(row[4]||"").toString().trim();

            let combined=(c1+" "+c2+" "+c3+" "+c4).toUpperCase();
            if(combined.includes("FIRST")||combined.includes("LAST")||combined.includes("NAME")) continue;

            let name=null;
            if(isName(c1)&&isName(c2)) name=c1+" "+c2;
            else if(isName(c2)&&isName(c3)) name=c2+" "+c3;
            else if(isName(c3)&&isName(c4)) name=c3+" "+c4;

            if(name && detected){
                name=cleanName(name);
                addSkater(name,detected);
                added++;
            }
        }

        if(added===0) showExcelErrorPopup();
        else { saveData(); loadGroup(); }
    };

    reader.readAsArrayBuffer(file);
}

function isName(x){
    if(!x||typeof x!=="string") return false;
    x=x.trim();
    if(x.length<2) return false;
    return /^[A-Za-z√Ä-√ø ' -]+$/.test(x);
}

// LOAD GROUP (TABLE + CARDS)
function loadGroup(){
    loadTable();
    loadMobileCards();
    updateScores();
}

// TABLE BUILD
function loadTable(){
    let tbody=document.querySelector("#scoreTable tbody");
    tbody.innerHTML="";

    groups[currentGroup].skaters.forEach(name=>{
        let row=document.createElement("tr");
        row.dataset.name=name;

        row.innerHTML=`
            <td class="name" onclick="editName('${name}')">${name}</td>
            <td></td><td></td><td></td><td></td><td></td>
            <td class="total">0</td>
            <td class="rank">-</td>
            <td><button onclick="undo('${name}')">Undo</button></td>
            <td><button class="danger" onclick="del('${name}')">Delete</button></td>
        `;

        distances.forEach((dist,i)=>{
            let cell=row.children[i+1];
            cell.appendChild(createDropdown(name,dist));
        });

        tbody.appendChild(row);
    });
}

// DROPDOWN (DESKTOP/TABLE)
function createDropdown(name,dist){
    let dd=document.createElement("select");
    dd.className="position";
    dd.innerHTML=`<option value="">-</option>`;
    let count=groups[currentGroup].skaters.length;
    for(let i=1;i<=count;i++) dd.innerHTML+=`<option>${i}</option>`;
    dd.onchange=()=>storeHistory(name,dist,dd);
    return dd;
}

// MOBILE CARDS
function loadMobileCards(){
    let box=document.getElementById("mobileCards");
    box.innerHTML="";

    groups[currentGroup].skaters.forEach(name=>{
        let card=document.createElement("div");
        card.className="card";
        card.dataset.name=name;

        let scoreHTML="";
        distances.forEach(dist=>{
            scoreHTML+=`
                <div class="card-row">
                    <span>${dist}m</span>
                    <span>${createMobileDropdownHTML(name,dist)}</span>
                </div>
            `;
        });

        card.innerHTML=`
            <h3 onclick="editName('${name}')">${name}</h3>
            ${scoreHTML}
            <div class="card-row"><b>Total</b><span class="total">0</span></div>
            <div class="card-row"><b>Rank</b><span class="rank">-</span></div>
            <button onclick="undo('${name}')">Undo</button>
            <button class="danger" onclick="del('${name}')">Delete</button>
        `;

        box.appendChild(card);
    });

    rebuildDropdowns(); // sync positions options
}

// MOBILE SELECT HTML
function createMobileDropdownHTML(name,dist){
    let count=groups[currentGroup].skaters.length;
    let html=`<select class="mPos" data-name="${name}" data-dist="${dist}" onchange="mobileScoreChange(this)">`;
    html+=`<option value="">-</option>`;
    for(let i=1;i<=count;i++) html+=`<option>${i}</option>`;
    html+=`</select>`;
    return html;
}

// WHEN MOBILE SELECT CHANGES ‚Üí UPDATE TABLE SELECT + HISTORY
function mobileScoreChange(el){
    let name=el.dataset.name;
    let dist=el.dataset.dist;
    let val=el.value;

    let row=document.querySelector(`#scoreTable tbody tr[data-name="${name}"]`);
    if(row){
        let idx=distances.indexOf(dist);
        let dd=row.querySelectorAll("select.position")[idx];
        if(dd){
            dd.value=val;
            storeHistory(name,dist,dd);
        }
    }
    el.setAttribute("data-last",val);
}

// HISTORY STORE FOR UNDO
function storeHistory(name,dist,dd){
    let hist=groups[currentGroup].history[name][dist];
    hist.push(dd.getAttribute("data-last")||"");
    dd.setAttribute("data-last",dd.value);
    updateScores();
    saveData();
}

// REBUILD DROPDOWNS OPTION COUNT AFTER ADD/DELETE
function rebuildDropdowns(){
    let count=groups[currentGroup].skaters.length;
    document.querySelectorAll("select.position, select.mPos").forEach(dd=>{
        let old=dd.value;
        dd.innerHTML=`<option value="">-</option>`;
        for(let i=1;i<=count;i++) dd.innerHTML+=`<option>${i}</option>`;
        dd.value=old;
    });
}

/* -----------------------------------------------------------
   SCORE UPDATE + SORT + MEDALS WITH TIES
------------------------------------------------------------ */
function updateScores(){
    const tableRows=[...document.querySelectorAll("#scoreTable tbody tr")];
    let anyScore=false;

    // Calculate totals from table selects only
    tableRows.forEach(row=>{
        let total=0;
        row.querySelectorAll("select.position").forEach(dd=>{
            let pos=Number(dd.value);
            if(points[pos]) total+=points[pos];
        });
        row.querySelector(".total").textContent=total;
        if(total>0) anyScore=true;
    });

    if(!anyScore){
        resetRanks();
        syncMobileFromTable();
        return;
    }

    applyRanking();      // ranks + medals only for >0 scores
    syncMobileFromTable();
}

// Clear ranks & medals (no scores)
function resetRanks(){
    document.querySelectorAll("#scoreTable tbody tr").forEach(row=>{
        row.querySelector(".rank").textContent="-";
        row.querySelector(".name").textContent=row.dataset.name;
    });
}

// Ranking + medals with ties
function applyRanking(){
    const tbody=document.querySelector("#scoreTable tbody");
    let rows=[...tbody.querySelectorAll("tr")];

    // Build array with totals
    let withTotals=rows.map(row=>({
        row,
        total:Number(row.querySelector(".total").textContent)
    }));

    // Sort all rows by total (high ‚Üí low)
    withTotals.sort((a,b)=>b.total - a.total);

    // Non-zero only for ranking and medals
    let nonZero=withTotals.filter(o=>o.total>0);
    if(nonZero.length===0){
        resetRanks();
        return;
    }

    // Unique score tiers for medals (dense ranking)
    let uniqueScores=[];
    nonZero.forEach(o=>{
        if(!uniqueScores.includes(o.total)) uniqueScores.push(o.total);
    });

    // Reorder rows in DOM according to sorted totals
    withTotals.forEach(o=>tbody.appendChild(o.row));

    // Reset all names & ranks first
    rows.forEach(row=>{
        row.querySelector(".name").textContent=row.dataset.name;
        row.querySelector(".rank").textContent="-";
    });

    // Assign ranks & medals for non-zero only
    nonZero.forEach(o=>{
        const row=o.row;
        const score=o.total;
        const tierIndex=uniqueScores.indexOf(score); // 0,1,2,...
        const displayRank=tierIndex+1;

        const nameCell=row.querySelector(".name");
        const raw=row.dataset.name;

        row.querySelector(".rank").textContent=displayRank;

        if(tierIndex===0){
            nameCell.innerHTML=`ü•á ${raw}`;
        } else if(tierIndex===1){
            nameCell.innerHTML=`ü•à ${raw}`;
        } else if(tierIndex===2){
            nameCell.innerHTML=`ü•â ${raw}`;
        } else {
            nameCell.textContent=raw; // no medal
        }
    });
}

// Sync totals, rank & name (with medals) into mobile cards
function syncMobileFromTable(){
    const cards=[...document.querySelectorAll("#mobileCards .card")];
    cards.forEach(card=>{
        const name=card.dataset.name;
        const row=document.querySelector(`#scoreTable tbody tr[data-name="${name}"]`);
        if(!row) return;

        const total=row.querySelector(".total").textContent;
        const rank=row.querySelector(".rank").textContent;
        const nameHTML=row.querySelector(".name").innerHTML;

        card.querySelector(".total").textContent=total;
        card.querySelector(".rank").textContent=rank;
        card.querySelector("h3").innerHTML=nameHTML;
    });
}

/* -----------------------------------------------------------
   UNDO + DELETE
------------------------------------------------------------ */
function undo(name){
    let g=groups[currentGroup];
    let hist=g.history[name];
    distances.forEach(dist=>{
        let stack=hist[dist];
        if(stack.length>0){
            let prev=stack.pop();

            // desktop
            let row=document.querySelector(`#scoreTable tbody tr[data-name="${name}"]`);
            if(row){
                let idx=distances.indexOf(dist);
                let dd=row.querySelectorAll("select.position")[idx];
                if(dd){
                    dd.value=prev || "";
                    dd.setAttribute("data-last",prev || "");
                }
            }

            // mobile
            let mdd=document.querySelector(`.card[data-name="${name}"] select.mPos[data-dist="${dist}"]`);
            if(mdd){
                mdd.value=prev || "";
                mdd.setAttribute("data-last",prev || "");
            }
        }
    });

    updateScores();
    saveData();
}

function del(name){
    let g=groups[currentGroup];
    g.skaters=g.skaters.filter(n=>n!==name);
    delete g.history[name];
    saveData();
    loadGroup();
}

/* -----------------------------------------------------------
   NAME EDIT POPUP
------------------------------------------------------------ */
let editTarget=null;

function editName(name){
    editTarget=name;
    document.getElementById("nameEditInput").value=name;
    document.getElementById("nameEditPopup").style.display="block";
}

function closeNamePopup(){
    document.getElementById("nameEditPopup").style.display="none";
}

function saveNameEdit(){
    let newName=cleanName(document.getElementById("nameEditInput").value.trim());
    if(!newName) return;

    let g=groups[currentGroup];
    let idx=g.skaters.indexOf(editTarget);
    if(idx>-1) g.skaters[idx]=newName;

    g.history[newName]=g.history[editTarget];
    delete g.history[editTarget];

    saveData();
    closeNamePopup();
    loadGroup();
}

/* -----------------------------------------------------------
   POPUPS (ERROR + HELP)
------------------------------------------------------------ */
function showExcelErrorPopup(){
    let p=document.getElementById("excelErrorPopup");
    p.style.display="block";
    p.style.animationName="slideDown";
}

function closeExcelErrorPopup(){
    document.getElementById("excelErrorPopup").style.display="none";
}

function openHelp(){
    document.getElementById("helpPopup").style.display="flex";
}
function closeHelp(){
    document.getElementById("helpPopup").style.display="none";
}

/* INIT */
loadGroup();
</script>

</body>
</html>
